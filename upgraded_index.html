<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AI Quiz Service ‚Äî Beautiful Minimal</title>
  <meta name="color-scheme" content="light dark" />
  <style>
    /* ================================
       Design Tokens ‚Äî Cohesive System
       ================================ */
    :root{
      /* Brand */
      --brand-50:#eef2ff; --brand-100:#e0e7ff; --brand-200:#c7d2fe; --brand-300:#a5b4fc;
      --brand-400:#818cf8; --brand-500:#6366f1; --brand-600:#4f46e5; --brand-700:#4338ca;
      --brand-800:#3730a3; --brand-900:#312e81;

      /* Neutrals */
      --bg: #0b0c10;
      --panel: #0f1117;
      --panel-2: #151a23;
      --text: #e6e7ea;
      --muted: #a9b1bc;
      --border: #222733;
      --success:#22c55e;
      --warn:#f59e0b;
      --danger:#ef4444;
      --info:#38bdf8;

      /* Surface (auto for light mode) */
      --shadow: 0 8px 24px rgba(0,0,0,.25);
      --radius: 14px;
      --radius-sm:10px;
      --radius-xs:8px;

      /* Spacing & Type */
      --space-1: .5rem;
      --space-2: .75rem;
      --space-3: 1rem;
      --space-4: 1.25rem;
      --space-5: 1.5rem;
      --space-6: 2rem;
      --font-sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";
      --fs-1: clamp(2rem, 2vw + 1rem, 3rem);
      --fs-2: clamp(1.15rem, .6vw + 1rem, 1.4rem);
      --fs-3: 1rem;
      --fs-4: .9rem;
      --focus: 0 0 0 3px rgba(99,102,241,.55), 0 0 0 6px rgba(99,102,241,.25);
      --card-grad: linear-gradient(180deg, rgba(99,102,241,.06), rgba(99,102,241,.02));
      --brand-grad: linear-gradient(135deg, var(--brand-600), var(--brand-400));
    }

    @media (prefers-color-scheme: light){
      :root{
        --bg:#f6f7fb; --panel:#ffffff; --panel-2:#f9fafb; --text:#111827; --muted:#6b7280;
        --border:#e5e7eb; --shadow:0 10px 30px rgba(20,20,20,.06);
      }
    }

    /* Base */
    *,*::before,*::after{ box-sizing:border-box }
    html,body{ height:100% }
    body{
      margin:0; font-family:var(--font-sans); background:radial-gradient(1200px 800px at 10% -10%, rgba(99,102,241,.20), transparent 60%),
      radial-gradient(800px 600px at 110% -20%, rgba(56,189,248,.18), transparent 60%), var(--bg);
      color:var(--text);
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }

    a{ color:var(--brand-400); text-decoration:none }
    a:hover{ text-decoration:underline }

    /* Skip link for keyboard users */
    .skip-link{
      position:absolute; left:-9999px; top:auto; width:1px; height:1px; overflow:hidden;
    }
    .skip-link:focus{
      left:1rem; top:1rem; width:auto; height:auto; padding:.5rem .75rem; background:var(--panel);
      border:1px solid var(--border); border-radius:8px; box-shadow:var(--focus); z-index:9999;
    }

    /* Layout */
    .container{ max-width:1100px; margin:0 auto; padding:var(--space-6) var(--space-3) }
    header{
      display:flex; align-items:center; justify-content:space-between; gap:var(--space-3); margin-bottom:var(--space-5);
    }
    .brand{
      display:flex; align-items:center; gap:.75rem;
    }
    .logo{
      width:40px; height:40px; border-radius:12px; background:var(--brand-grad); box-shadow:0 10px 20px rgba(99,102,241,.25);
      display:grid; place-items:center; font-weight:700; color:white;
    }
    .brand h1{ font-size:var(--fs-1); line-height:1.1; margin:0 }
    .brand p{ margin:0; color:var(--muted); font-size:var(--fs-4) }

    nav{
      display:flex; gap:.5rem; flex-wrap:wrap; align-items:center;
    }

    /* Buttons */
    .btn{
      appearance:none; border:1px solid var(--border); background:var(--panel);
      color:var(--text); padding:.65rem .95rem; border-radius:12px; font-weight:600; font-size:.95rem;
      transition:transform .15s ease, box-shadow .2s ease, border-color .2s ease, background .2s ease;
      cursor:pointer;
    }
    .btn:hover{ transform:translateY(-1px); box-shadow:var(--shadow); border-color:rgba(99,102,241,.4) }
    .btn:active{ transform:translateY(0) scale(.99) }
    .btn:focus-visible{ outline:none; box-shadow:var(--focus) }
    .btn-primary{
      background:var(--brand-grad); border-color:transparent; color:white;
    }
    .btn-primary:hover{ box-shadow:0 10px 24px rgba(99,102,241,.35) }
    .btn-outline{
      background:transparent; border-color:rgba(99,102,241,.45); color:var(--brand-300);
    }
    .btn-success{ background:linear-gradient(135deg,var(--success),#16a34a); color:white; border-color:transparent }
    .btn-warn{ background:linear-gradient(135deg,var(--warn),#d97706); color:white; border-color:transparent }
    .btn-ghost{ background:transparent }

    /* Cards */
    .card{
      background:var(--panel); border:1px solid var(--border); border-radius:var(--radius);
      box-shadow:var(--shadow); padding:var(--space-5);
      backdrop-filter:saturate(140%) blur(6px); background-image:var(--card-grad);
    }
    .card + .card{ margin-top:var(--space-4) }
    .card h2{ font-size:var(--fs-2); margin:0 0 .5rem }
    .card p.lede{ color:var(--muted); margin:0 0 1rem }

    /* Grid */
    .grid{ display:grid; gap:var(--space-4); grid-template-columns:1.1fr .9fr }
    @media (max-width: 960px){ .grid{ grid-template-columns:1fr } }

    /* Forms */
    .form-group{ margin-bottom:var(--space-3) }
    label{ display:block; font-weight:650; margin-bottom:.5rem; color:var(--muted) }
    input,select,textarea{
      width:100%; background:var(--panel-2); color:var(--text);
      border:1px solid var(--border); border-radius:12px; padding:.8rem .9rem; font-size:var(--fs-3);
      transition:border-color .2s ease, box-shadow .2s ease, background .2s ease;
    }
    input::placeholder, textarea::placeholder{ color:#8b93a1 }
    input:focus,select:focus,textarea:focus{ outline:none; border-color:rgba(99,102,241,.55); box-shadow:var(--focus) }

    /* Quiz */
    .quiz-question{
      background:var(--panel-2); border:1px solid var(--border); border-left:4px solid var(--brand-500);
      border-radius:12px; padding:var(--space-3); margin-bottom:var(--space-3);
    }
    .quiz-meta{ color:var(--muted); font-size:.9rem; margin:.35rem 0 .75rem }

    .option{
      display:block; background:var(--panel); border:1px solid var(--border); border-radius:10px;
      padding:.6rem .75rem; margin:.55rem 0; cursor:pointer; transition:transform .1s ease, border-color .2s ease, background .2s ease;
    }
    .option:hover{ transform:translateY(-1px); border-color:rgba(99,102,241,.45) }
    .option input{ margin-right:.6rem; inline-size:auto }

    /* Status / Toast (aria-live) */
    #status{ margin:0 0 var(--space-3); padding:.9rem 1rem; border-radius:12px; font-weight:650; border:1px solid; }
    .status--info{ background:rgba(56,189,248,.12); color:#7ed3ff; border-color:rgba(56,189,248,.35) }
    .status--success{ background:rgba(34,197,94,.12); color:#7ee2a2; border-color:rgba(34,197,94,.35) }
    .status--error{ background:rgba(239,68,68,.12); color:#ff9a9a; border-color:rgba(239,68,68,.35) }
    .status--warn{ background:rgba(245,158,11,.12); color:#ffd28a; border-color:rgba(245,158,11,.35) }
    .hidden{ display:none !important }

    /* Results & History */
    .results{ background:var(--panel-2); border:1px solid var(--border); border-radius:12px; padding:var(--space-4); margin-top:var(--space-3) }
    .score{ font-size:2.2rem; font-weight:800; text-align:center; margin:0 0 .5rem }
    .history-item{
      background:var(--panel-2); border:1px solid var(--border); border-radius:12px; padding:var(--space-3);
      display:flex; align-items:center; justify-content:space-between; gap:1rem; margin:.75rem 0;
    }
    .score-badge{
      padding:.4rem .75rem; border-radius:999px; font-weight:800; background:var(--brand-600); color:white; min-width:64px; text-align:center;
    }

    .hint-box{
      background:rgba(245, 229, 141, .12); border:1px dashed #e6cf52; color:#ffe38a;
      border-radius:10px; padding:.75rem .9rem; margin-top:.5rem;
    }
    .hint-usage{ color:var(--muted); font-size:.8rem; margin-top:.35rem }

    /* Loaders */
    .loading{ display:inline-block; width:18px; height:18px; border:3px solid rgba(255,255,255,.15); border-top:3px solid white;
      border-radius:50%; animation:spin 1s linear infinite; margin-right:.5rem; vertical-align:-4px }
    .loading.dark{ border-color:rgba(99,102,241,.25); border-top-color:var(--brand-500) }

    @keyframes spin{ to{ transform:rotate(360deg) } }

    /* Reduced motion */
    @media (prefers-reduced-motion: reduce){
      *{ transition:none !important; animation:none !important }
    }

    /* Footer */
    footer{ color:var(--muted); font-size:.85rem; text-align:center; margin-top:var(--space-6) }
  </style>

  <!-- Configure backend API base for hosted environment -->
  <script>
    window.API_BASE = 'https://ai-quiz-microservice.onrender.com'; /* override at deploy if needed */
  </script>
</head>
<body>
  <a href="#main" class="skip-link">Skip to main content</a>

  <div class="container">
    <header aria-label="Top">
      <div class="brand" aria-label="Brand">
        <div class="logo" aria-hidden="true">AQ</div>
        <div>
          <h1>AI Quiz Service</h1>
          <p>Generate ‚Ä¢ Solve ‚Ä¢ Evaluate ‚Äî beautifully</p>
        </div>
      </div>
      <nav aria-label="Actions">
        <button class="btn btn-outline" id="btnToggleAuth" type="button">Sign in</button>
      </nav>
    </header>

    <!-- ARIA live status -->
    <div id="status" class="hidden" role="status" aria-live="polite"></div>

    <!-- Auth Card -->
    <section id="loginSection" class="card" aria-label="Authentication">
      <h2>üîê Authentication</h2>
      <p class="lede">Use any credentials in dev; production uses JWT (HS256).</p>

      <div id="loginFormFields">
        <div class="form-group">
          <label for="username">Username</label>
          <input id="username" placeholder="Enter your username" value="demo" autocomplete="username" />
        </div>

        <div class="form-group">
          <label for="password">Password</label>
          <input id="password" placeholder="Enter your password" type="password" value="demo123" autocomplete="current-password" />
        </div>

        <button class="btn btn-primary" onclick="login()">
          <span id="loginLoader" class="loading hidden"></span>
          Login
        </button>
        <button class="btn btn-ghost" onclick="showRegister(true)">Create an account</button>
      </div>

      <div id="registerForm" class="hidden" aria-hidden="true">
        <div class="form-group">
          <label for="regUsername">Username</label>
          <input id="regUsername" placeholder="Choose a username" />
        </div>
        <div class="form-group">
          <label for="regEmail">Email</label>
          <input id="regEmail" type="email" placeholder="you@example.com" />
        </div>
        <div class="form-group">
          <label for="regPassword">Password</label>
          <input id="regPassword" type="password" placeholder="Create a password" />
        </div>
        <div style="display:flex; gap:.6rem; flex-wrap:wrap">
          <button class="btn btn-success" onclick="registerUser()">Register</button>
          <button class="btn" onclick="showRegister(false)">Back to Login</button>
        </div>
      </div>
    </section>

    <!-- Main app -->
    <main id="main" class="hidden" tabindex="-1">
      <div class="grid" style="margin-top: var(--space-4)">
        <!-- Create Quiz -->
        <section class="card" aria-label="Create quiz">
          <h2>üìù Create Quiz</h2>
          <div class="form-group">
            <label for="subject">Subject</label>
            <select id="subject">
              <option>Mathematics</option><option>Science</option><option>History</option><option>English</option>
            </select>
          </div>
          <div class="form-group">
            <label for="gradeLevel">Grade Level</label>
            <select id="gradeLevel">
              <option value="6">Grade 6</option><option value="7">Grade 7</option><option value="8">Grade 8</option>
              <option value="9">Grade 9</option><option value="10">Grade 10</option>
            </select>
          </div>
          <div class="form-group">
            <label for="numQuestions">Number of Questions</label>
            <select id="numQuestions">
              <option value="3">3</option><option value="5">5</option><option value="8">8</option><option value="10">10</option>
            </select>
          </div>
          <div class="form-group">
            <label for="difficulty">Difficulty</label>
            <select id="difficulty">
              <option value="easy">Easy</option><option value="medium">Medium</option>
              <option value="hard">Hard</option><option value="adaptive">Adaptive</option>
            </select>
          </div>
          <button class="btn btn-primary" onclick="createQuiz()">
            <span id="createLoader" class="loading hidden"></span>
            Generate with AI
          </button>
        </section>

        <!-- History & Filters -->
        <section class="card" aria-label="Quiz history">
          <h2>üìä Quiz History</h2>
          <div class="form-group">
            <label for="historySubject">Filter by Subject</label>
            <select id="historySubject">
              <option value="">All Subjects</option>
              <option value="Mathematics">Mathematics</option><option value="Science">Science</option>
              <option value="History">History</option><option value="English">English</option>
            </select>
          </div>
          <div class="form-group">
            <label for="minMarks">Minimum Score (%)</label>
            <input id="minMarks" type="number" min="0" max="100" placeholder="0" />
          </div>
          <div class="form-group">
            <label for="maxMarks">Maximum Score (%)</label>
            <input id="maxMarks" type="number" min="0" max="100" placeholder="100" />
          </div>
          <div class="form-group">
            <label for="fromDate">From Date</label>
            <input id="fromDate" type="date" />
          </div>
          <div class="form-group">
            <label for="toDate">To Date</label>
            <input id="toDate" type="date" />
          </div>
          <div class="form-group">
            <label for="filterGradeLevel">Filter by Grade</label>
            <select id="filterGradeLevel">
              <option value="">All Grades</option>
              <option value="8">Grade 8</option><option value="9">Grade 9</option>
              <option value="10">Grade 10</option><option value="11">Grade 11</option>
              <option value="12">Grade 12</option>
            </select>
          </div>
          <div style="display:flex; gap:.6rem; flex-wrap:wrap">
            <button class="btn" onclick="loadHistory()"><span id="historyLoader" class="loading dark hidden"></span>Load History</button>
            <button class="btn btn-ghost" onclick="clearFilters()">Clear Filters</button>
          </div>
          <div id="historyResults" style="margin-top:.5rem"></div>
        </section>

        <!-- Leaderboard -->
        <section class="card" aria-label="Leaderboard">
          <h2>üèÜ Leaderboard</h2>
          <div class="form-group">
            <label for="leaderboardSubject">Subject</label>
            <select id="leaderboardSubject">
              <option>Mathematics</option><option>Science</option><option>History</option><option>English</option>
            </select>
          </div>
          <div class="form-group">
            <label for="leaderboardGrade">Grade Level</label>
            <select id="leaderboardGrade">
              <option value="6">6</option><option value="7">7</option><option value="8">8</option>
              <option value="9">9</option><option value="10">10</option>
            </select>
          </div>
          <div class="form-group">
            <label for="leaderboardLimit">Top Players</label>
            <select id="leaderboardLimit">
              <option value="5">Top 5</option><option value="10">Top 10</option><option value="20">Top 20</option>
            </select>
          </div>
          <div style="display:flex; gap:.6rem; flex-wrap:wrap">
            <button class="btn btn-success" onclick="loadLeaderboard()"><span id="leaderboardLoader" class="loading hidden"></span>View Leaderboard</button>
            <button class="btn btn-ghost" onclick="loadMyRank()">My Rank</button>
          </div>
          <div id="leaderboardResults" style="margin-top:.5rem"></div>
          <div id="myRankResults"></div>
        </section>
      </div>

      <!-- Take Quiz -->
      <section id="quizSection" class="card hidden" aria-label="Take quiz">
        <h2>üéØ Take Quiz</h2>
        <div id="quizContent" aria-live="polite"></div>
        <div id="currentHints"></div>
        <div style="display:flex; gap:.6rem; flex-wrap:wrap">
          <button class="btn btn-success" onclick="submitQuiz()"><span id="submitLoader" class="loading hidden"></span>Submit Quiz</button>
          <button id="retryBtn" class="btn btn-warn hidden" onclick="retryQuiz()">Retry Quiz</button>
        </div>
      </section>

      <!-- Results -->
      <section id="resultsSection" class="card hidden" aria-label="Results">
        <h2>üèÅ Results</h2>
        <div id="resultsContent"></div>
        <div style="margin-top:.75rem; display:flex; gap:.6rem; align-items:center; flex-wrap:wrap">
          <input id="emailForResults" type="email" placeholder="Enter another email (optional)" />
          <button class="btn" onclick="sendResultsEmail()">üìß Email Me The Outline</button>
        </div>
      </section>
    </main>

    <footer>Built with FastAPI + JWT + adaptive AI. Beautifully fronted in plain HTML/CSS/JS.</footer>
  </div>

  <script>
    /* ================================
       State & Utilities
       ================================ */
    let authToken = sessionStorage.getItem('authToken') || null;
    let currentQuiz = null;
    let currentQuestions = [];
    let userAnswers = {};
    let quizStartTime = null;

    const API_BASE = window.API_BASE || location.origin;

    const $ = (id)=>document.getElementById(id);
    const show = (el)=>el.classList.remove('hidden');
    const hide = (el)=>el.classList.add('hidden');

    function toast(msg, type='info'){
      const el = $('status');
      el.textContent = msg;
      el.className = ''; // reset
      el.classList.add(type==='success'?'status--success':type==='error'?'status--error':type==='warn'?'status--warn':'status--info');
      el.id = 'status'; // keep id
      el.classList.remove('hidden');
      clearTimeout(el._t);
      el._t = setTimeout(()=>el.classList.add('hidden'), 5000);
    }

    function toggleLoader(id, on=true){ const el=$(id); if(!el) return; el.classList.toggle('hidden', !on); }

    async function apiCall(endpoint, method='GET', data=null){
      const cfg = {
        method,
        headers:{ 'Content-Type':'application/json', ...(authToken?{Authorization:`Bearer ${authToken}`}:{}) }
      };
      if(data) cfg.body = JSON.stringify(data);
      const res = await fetch(`${API_BASE}${endpoint}`, cfg);
      let body;
      try{ body = await res.json(); }catch{ body = {}; }
      if(!res.ok){
        let msg = body?.error?.message ?? body?.detail ?? res.statusText ?? 'API Error';
        throw new Error(typeof msg==='string'?msg:JSON.stringify(msg));
      }
      return body;
    }

    /* ================================
       Auth
       ================================ */
    function updateAuthUI(){
      const isAuthed = !!authToken;
      $('btnToggleAuth').textContent = isAuthed ? 'Sign out' : 'Sign in';
      $('btnToggleAuth').onclick = isAuthed ? logout : ()=>{ $('loginSection').scrollIntoView({behavior:'smooth'}); };

      if(isAuthed){
        hide($('loginSection'));
        show($('main'));
        $('main').focus();
      } else {
        show($('loginSection'));
        hide($('main'));
      }
    }

    function showRegister(showIt){
      $('registerForm').setAttribute('aria-hidden', showIt ? 'false' : 'true');
      if(showIt){
        hide($('loginFormFields'));
        show($('registerForm'));
      } else {
        show($('loginFormFields'));
        hide($('registerForm'));
      }
    }

    async function login(){
      const username = $('username').value.trim();
      const password = $('password').value.trim();
      if(!username || !password){ toast('Please enter username and password','error'); return; }

      toggleLoader('loginLoader', true);
      try{
        const r = await apiCall('/auth/login','POST',{username,password});
        authToken = r.access_token;
        sessionStorage.setItem('authToken', authToken);
        toast('Login successful! Welcome to AI Quiz Service','success');
        updateAuthUI();
        loadHistory();
      }catch(e){ toast(`Login failed: ${e.message}`,'error'); }
      finally{ toggleLoader('loginLoader', false); }
    }

    async function registerUser(){
      const username = $('regUsername').value.trim();
      const email = $('regEmail').value.trim();
      const password = $('regPassword').value.trim();
      if(!username || !email || !password){ toast('Please fill username, email and password','error'); return; }
      try{
        await apiCall('/auth/register','POST',{username,email,password});
        toast('Registration successful! You can now login.','success');
        showRegister(false);
        $('username').value = username; $('password').value = password;
      }catch(e){ toast(`Registration failed: ${e.message}`,'error'); }
    }

    function logout(){
      authToken = null;
      sessionStorage.removeItem('authToken');
      currentQuiz = null; currentQuestions = []; userAnswers = {};
      toast('You have been signed out.','info');
      updateAuthUI();
    }

    /* ================================
       Quiz Lifecycle
       ================================ */
    async function createQuiz(){
      const subject = $('subject').value;
      const gradeLevel = $('gradeLevel').value;
      const numQuestions = parseInt($('numQuestions').value,10);
      const difficulty = $('difficulty').value;

      toggleLoader('createLoader', true);
      try{
        const payload = {
          subject, grade_level: gradeLevel, num_questions: numQuestions, difficulty,
          topics:[subject.toLowerCase()], question_types:['MCQ','TF'], adaptive: difficulty==='adaptive'
        };
        currentQuiz = await apiCall('/quizzes','POST', payload);
        currentQuestions = await apiCall(`/quizzes/${currentQuiz.id}/questions`);
        toast(`Quiz created: ${numQuestions} questions generated with AI`, 'success');
        displayQuiz();
      }catch(e){ toast(`Failed to create quiz: ${e.message}`,'error'); }
      finally{ toggleLoader('createLoader', false); }
    }

    function displayQuiz(){
      if(!currentQuestions?.length) return;
      quizStartTime = Date.now(); userAnswers = {};
      const host = $('quizContent'); host.innerHTML = '';

      currentQuestions.forEach((q, i)=>{
        const wrap = document.createElement('div'); wrap.className='quiz-question';
        const optionsHtml = (q.options?.length? q.options.map(opt=>`
          <label class="option">
            <input type="radio" name="q_${q.id}" value="${opt}" onchange="saveAnswer(${q.id}, '${String(opt).replace(/"/g,'&quot;')}')" />
            ${opt}
          </label>`).join('') :
          `<textarea placeholder="Enter your answer..." onchange="saveAnswer(${q.id}, this.value)"></textarea>`
        );
        wrap.innerHTML = `
          <h3>Q${i+1}. ${q.question_text}</h3>
          <div class="quiz-meta"><strong>Topic:</strong> ${q.topic} ‚Ä¢ <strong>Difficulty:</strong> ${q.difficulty} ‚Ä¢ <strong>Points:</strong> ${q.points}</div>
          ${optionsHtml}
          <button class="btn" style="margin-top:.5rem" onclick="getHint(${currentQuiz.id}, ${q.id})">üí° Get AI Hint</button>
          <div id="hint_${q.id}"></div>
        `;
        host.appendChild(wrap);
      });

      show($('quizSection')); hide($('resultsSection')); $('quizSection').scrollIntoView({behavior:'smooth'});
    }

    function saveAnswer(questionId, answer){
      const isMCQ = ['True','False'].includes(answer) || /^Option/.test(answer) || /^[A-Za-z]\s*[=)]/.test(answer) || /^[A-Za-z]\s*\d+/.test(answer);
      const a = {
        question_id: questionId,
        time_spent_seconds: Math.floor((Date.now()-quizStartTime)/1000)
      };
      if(isMCQ){ a.selected_option = answer; } else { a.answer_text = answer || ''; }
      userAnswers[questionId] = a;
    }

    async function getHint(quizId, questionId){
      try{
        const hint = await apiCall(`/quizzes/${quizId}/questions/${questionId}/hint`, 'POST', {});
        const el = $(`hint_${questionId}`);
        el.innerHTML = `<div class="hint-box"><div>üí° <strong>AI Hint:</strong> ${hint.hint}</div><div class="hint-usage">Hints used: ${hint.usage_count}/${hint.max_hints}</div></div>`;
      }catch(e){
        if(String(e.message).includes('429')) toast('Hint limit reached for this question (max 3).','error');
        else toast(`Failed to get hint: ${e.message}`,'error');
      }
    }

    async function submitQuiz(){
      if(!Object.keys(userAnswers).length){ toast('Please answer at least one question','error'); return; }
      toggleLoader('submitLoader', true);
      try{
        const cleanAnswers = Object.values(userAnswers).map(a=>{
          const out = { question_id:a.question_id, time_spent_seconds:a.time_spent_seconds || 30 };
          if(a.selected_option!=null){ out.selected_option = a.selected_option; }
          else if(a.answer_text){ out.answer_text = a.answer_text; } else { out.answer_text=''; }
          return out;
        });
        const payload = { answers: cleanAnswers, time_taken_minutes: Math.max(1, Math.floor((Date.now()-quizStartTime)/60000)) };
        const results = await apiCall(`/quizzes/${currentQuiz.id}/submit`, 'POST', payload);
        displayResults(results); loadHistory();
      }catch(e){ toast(`Failed to submit quiz: ${e.message}`,'error'); }
      finally{ toggleLoader('submitLoader', false); }
    }

    function displayResults(results){
      const el = $('resultsContent');
      const pct = Math.round(results.percentage);
      const color = pct>=80? 'var(--success)': pct>=60? 'var(--warn)':'var(--danger)';
      el.innerHTML = `
        <div class="results">
          <div class="score" style="color:${color}">${pct}%</div>
          <p style="text-align:center; color:var(--muted); margin:.25rem 0 1rem">
            <strong>Score:</strong> ${results.total_score}/${results.max_possible_score} ‚Ä¢
            <strong>Correct:</strong> ${results.correct_answers}/${results.total_questions} ‚Ä¢
            <strong>Level:</strong> ${results.performance_level} ‚Ä¢
            <strong>Time:</strong> ${results.time_taken_minutes} min
          </p>

          ${results.topic_scores?`
            <div class="card" style="padding:1rem; background:var(--panel); border:1px dashed var(--border); margin:.5rem 0 0">
              <h3 style="margin:0 0 .5rem">üìà Topic Performance</h3>
              ${Object.entries(results.topic_scores).map(([t,s])=>`
                <div style="display:flex; justify-content:space-between; padding:.35rem 0; border-bottom:1px dashed var(--border)">
                  <span>${t}</span><strong>${Math.round(s)}%</strong>
                </div>
              `).join('')}
            </div>`:''}

          ${Array.isArray(results.suggestions)&&results.suggestions.length?`
            <div class="card" style="margin-top:.75rem">
              <h3 style="margin:0 0 .4rem">ü§ñ AI Suggestions</h3>
              <ul>${results.suggestions.map(s=>`<li>${s}</li>`).join('')}</ul>
            </div>`:''}

          ${Array.isArray(results.strengths)&&results.strengths.length?`
            <div class="card" style="margin-top:.75rem; border-left:4px solid var(--success)">
              <h3 style="margin:0 0 .4rem">üí™ Strengths</h3>
              <ul>${results.strengths.map(s=>`<li>${s}</li>`).join('')}</ul>
            </div>`:''}

          ${Array.isArray(results.weaknesses)&&results.weaknesses.length?`
            <div class="card" style="margin-top:.75rem; border-left:4px solid var(--danger)">
              <h3 style="margin:0 0 .4rem">üéØ Improve</h3>
              <ul>${results.weaknesses.map(s=>`<li>${s}</li>`).join('')}</ul>
            </div>`:''}
        </div>
      `;
      hide($('quizSection')); show($('resultsSection'));
      $('retryBtn').classList.remove('hidden');
      toast(`Quiz completed! Score: ${pct}%`, 'success');
    }

    async function retryQuiz(){
      if(!currentQuiz?.id){ toast('No quiz available to retry','error'); return; }
      try{
        const r = await apiCall(`/quizzes/${currentQuiz.id}/retry`, 'POST', { reason:'Retry to improve score' });
        if(!r.new_quiz_id) throw new Error('No new quiz ID returned');
        toast('Retry created! Loading new questions‚Ä¶', 'info');
        currentQuiz.id = r.new_quiz_id;
        currentQuestions = await apiCall(`/quizzes/${currentQuiz.id}/questions`);
        userAnswers = {}; quizStartTime = Date.now();
        displayQuiz(); $('retryBtn').classList.add('hidden');
        toast(`Retry quiz loaded! ${r.message || ''}`, 'success');
      }catch(e){ toast(`Failed to create retry: ${e.message}`,'error'); }
    }

    /* ================================
       History & Leaderboard
       ================================ */
    async function loadHistory(){
      toggleLoader('historyLoader', true);
      try{
        let endpoint = '/quizzes/history'; // aligned with service
        const params = new URLSearchParams();
        const subject = $('historySubject').value;
        const minMarks = $('minMarks').value;
        const maxMarks = $('maxMarks').value;
        const fromDate = $('fromDate').value;
        const toDate = $('toDate').value;
        const gradeLevel = $('filterGradeLevel').value;

        if(subject) params.append('subject', subject);
        if(minMarks) params.append('min_marks', minMarks);
        if(maxMarks) params.append('max_marks', maxMarks);
        if(fromDate) params.append('from_date', fromDate);
        if(toDate) params.append('to_date', toDate);
        if(gradeLevel) params.append('grade', gradeLevel);

        if(params.toString()) endpoint += `?${params.toString()}`;
        const history = await apiCall(endpoint);
        renderHistory(history);
      }catch(e){ toast(`Failed to load history: ${e.message}`,'error'); }
      finally{ toggleLoader('historyLoader', false); }
    }

    function renderHistory(history){
      const host = $('historyResults');
      if(!history?.submissions?.length){
        host.innerHTML = `<p style="color:var(--muted); text-align:center; margin-top:.5rem">No quiz history yet ‚Äî take a quiz to see results here.</p>`;
        return;
      }
      host.innerHTML = `
        <h3 style="margin:.5rem 0">üìã Recent Submissions (${history.total} total)</h3>
        ${Object.keys(history.filters_applied||{}).length? `<div style="color:var(--muted); font-size:.85rem">Filters: ${
          Object.entries(history.filters_applied).map(([k,v])=>`${k}: ${v}`).join(', ')
        }</div>`:''}
        ${history.submissions.map(s=>{
          const d = s.submitted_at? new Date(s.submitted_at): null;
          const ds = d? d.toLocaleString(): 'In Progress';
          return `
            <div class="history-item">
              <div>
                <strong>${s.quiz_title||'Quiz'}</strong><br />
                <small style="color:var(--muted)">${s.subject} ‚Ä¢ Grade ${s.grade_level}<br />üìÖ ${ds} ‚Ä¢ ${s.is_completed?'‚úÖ Completed':'‚è≥ In Progress'}</small>
              </div>
              <div class="score-badge" style="background:${s.percentage!=null?'var(--brand-600)':'#475569'}">
                ${s.percentage!=null ? Math.round(s.percentage)+'%' : 'N/A'}
              </div>
            </div>
          `;
        }).join('')}
        <div style="text-align:center; color:var(--muted); font-size:.8rem; margin-top:.25rem">Results cached for speed ‚ö°</div>
      `;
    }

    function clearFilters(){
      $('historySubject').value = '';
      $('minMarks').value = '';
      $('maxMarks').value = '';
      $('fromDate').value = '';
      $('toDate').value = '';
      $('filterGradeLevel').value = '';
      loadHistory(); toast('Filters cleared','info');
    }

    async function loadLeaderboard(){
      toggleLoader('leaderboardLoader', true);
      try{
        const subject = $('leaderboardSubject').value;
        const gradeLevel = $('leaderboardGrade').value;
        const limit = $('leaderboardLimit').value;
        const endpoint = `/leaderboard?subject=${encodeURIComponent(subject)}&grade_level=${encodeURIComponent(gradeLevel)}&limit=${encodeURIComponent(limit)}&ranking_type=best_percentage`;
        const lb = await apiCall(endpoint);
        renderLeaderboard(lb);
      }catch(e){ toast(`Failed to load leaderboard: ${e.message}`,'error'); }
      finally{ toggleLoader('leaderboardLoader', false); }
    }

    function renderLeaderboard(lb){
      const host = $('leaderboardResults');
      if(!lb?.entries?.length){
        host.innerHTML = `<p style="color:var(--muted); text-align:center; margin-top:.5rem">No leaderboard data yet. Take quizzes to rank!</p>`;
        return;
      }
      host.innerHTML = `
        <h3 style="margin:.5rem 0">üèÜ ${lb.subject} ‚Äî Grade ${lb.grade_level}</h3>
        <div style="color:var(--muted); font-size:.85rem; margin-bottom:.35rem">Participants: ${lb.total_users} ‚Ä¢ Generated: ${new Date(lb.generated_at).toLocaleString()}</div>
        ${lb.entries.map((e,i)=>{
          const medal = i===0?'ü•á':i===1?'ü•à':i===2?'ü•â':`#${e.rank}`;
          return `
            <div class="history-item" style="background:${i<3?'rgba(34,197,94,.08)':'var(--panel-2)'}">
              <div>
                <strong>${medal} ${e.username}</strong><br />
                <small style="color:var(--muted)">Best: ${e.best_percentage.toFixed(1)}% ‚Ä¢ Avg: ${e.average_score.toFixed(1)} ‚Ä¢ Quizzes: ${e.total_quizzes}<br />Accuracy: ${e.accuracy_percentage.toFixed(1)}% ‚Ä¢ Activity: ${e.activity_score?.toFixed?.(0) ?? '‚Äî'}</small>
              </div>
              <div class="score-badge" style="background:${i<3?'var(--success)':'var(--brand-600)'}">${e.best_percentage.toFixed(1)}%</div>
            </div>
          `;
        }).join('')}
      `;
    }

    async function loadMyRank(){
      try{
        const subject = $('leaderboardSubject').value;
        const gradeLevel = $('leaderboardGrade').value;
        const me = await apiCall(`/leaderboard/my-rank?subject=${encodeURIComponent(subject)}&grade_level=${encodeURIComponent(gradeLevel)}`);
        const host = $('myRankResults');
        const pctText = me.percentile ? `(Top ${(100 - me.percentile).toFixed(1)}%)` : '';
        const gap = me.score_gap_to_leader != null ? `${me.score_gap_to_leader.toFixed(1)}% behind leader` : 'You are the leader!';
        host.innerHTML = `
          <div class="card" style="margin-top:.6rem; border-left:4px solid var(--info)">
            <h3 style="margin:0 0 .25rem">üìä Your Ranking</h3>
            <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:.5rem">
              <div><strong>Rank:</strong> #${me.current_rank} / ${me.total_participants}</div>
              <div><strong>Percentile:</strong> ${pctText}</div>
              <div><strong>Best:</strong> ${me.best_percentage.toFixed(1)}%</div>
              <div><strong>Average:</strong> ${me.average_score.toFixed(1)}</div>
              <div><strong>Quizzes:</strong> ${me.total_quizzes}</div>
              <div><strong>Gap:</strong> ${gap}</div>
            </div>
          </div>
        `;
      }catch(e){
        if(String(e.message).includes('404')) toast('No ranking data for this subject/grade yet. Take a quiz first!','warn');
        else toast(`Failed to load your rank: ${e.message}`,'error');
      }
    }

    /* ================================
       Email convenience
       ================================ */
    function sendResultsEmail(){
      const email = ($('emailForResults').value||'').trim();
      if(email) toast('Using provided email for delivery if server allows.','info');
      else toast('Using your registered email if server is configured.','info');
      toast('If notifications are enabled on the server, results will arrive shortly.','success');
    }

    /* ================================
       Init
       ================================ */
    document.addEventListener('DOMContentLoaded', ()=>{
      // Hide all loaders initially
      ['loginLoader','createLoader','submitLoader','historyLoader','leaderboardLoader'].forEach(id=>{ const el=$(id); if(el) el.classList.add('hidden'); });

      updateAuthUI();

      // Keyboard nicety: toggle auth panel quickly
      $('btnToggleAuth').addEventListener('click', ()=>{
        if(authToken) return; // handled in logout
        $('loginSection').scrollIntoView({behavior:'smooth'});
      });

      console.log('Frontend ready. API_BASE:', API_BASE);
    });
  </script>
</body>
</html>